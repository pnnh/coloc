<% result = markdown @article.content
   toc = result[1] %>

<!DOCTYPE html>
<html>
<head>
    <%= render 'layouts/header', title: @article.title %>
    <%= stylesheet_link_tag  'articles', media: 'all' %>
    <meta name="keywords" content="<%=@article.tags%>">
    <meta name="description" content="<%=trunc_desc(@article.content)%>" />
    <meta name="author" content="<%=@article.user.name%>">
</head>
<body>

<%= render 'layouts/navbar' do %>
    <div class="dropdown table-card-cell rcard">
        <a href="<%= request.path.sub(article_path(@article), articles_path) %>">
            上级
        </a>
    </div>
    <% if toc.length > 0 %>
        <div class="dropdown table-card-cell rcard">
            <a class="dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                目录
                <span class="caret"></span>
            </a>
            <ul class="dropdown-menu">
                <%  l = toc.map { |m| m[0].to_i }.min
                    toc.each  do |m| %>
                    <li><a href="#<%=m[1]%>"><%== '&nbsp;' * 3 * (m[0].to_i - l) %><%=m[2]%></a></li>
                <% end %>
            </ul>
        </div>
    <% end %>
    <% if current_user?(@article.user) %>
        <div class="dropdown table-card-cell rcard">
            <a href="<%= request.path + '/edit' %>">
                修改
            </a>
        </div>
    <% end %>
<% end %>

<div id="fixed-before" class="sub-header">
    <div class="flex-container">
        <div class="flex-content card">
    <h3 class="title">
        <%= @article.title %>
        <% if @article.visible == 2 %>
            <span class="glyphicon glyphicon-lock" aria-hidden="true"></span>
        <% end %>
    </h3>
    <div class="name">
        <% if @article.visible == 1  %>
            匿名
        <% else %>
            <%= link_to @article.user.name, user_path(@article.user_id), class: 'nickname' %>
        <% end %>
        <span class="time"><%=update_time(@article.updated_at)%></span>
    </div>
        </div>
    </div>
</div>

<div class="body flex-container-21 channels">
    <div class="flex-left">
        <div class="flex-body">
            <div class="box article">
                <div class="box-body">
                    <%= result[0] %>
                </div>
            </div>
        </div>
    </div>
    <div class="flex-right">
        <div id="fixed" class="flex-body">
            <% if !@article.copyright.blank? %>
                <div class="box">
                    <div class="box-title">
                        版权
                    </div>
                    <div class="box-body">
                        <% if /^https?:\/\//.match(@article.copyright) %>
                            <%= link_to @article.copyright, @article.copyright, target: '_blank' %>
                        <% else %>
                            <%= @article.copyright %>
                        <% end %>
                    </div>
                </div>
            <% end %>
            <div class="box tags">
                <div class="box-title">
                    标签
                </div>
                <div class="box-body tagcloud">
                    <% if !@tags.nil? && @tags.length > 0
                           @tags.each do |t| %>
                            <%= link_to t, channel_articles_path(@article.channel_id, keyword: t), class: 'tag' %>
                        <% end else %>
                        暂无
                    <% end %>
                </div>
            </div>
            <div class="box recomends">
                <div class="box-title">
                    相关推荐
                </div>
                <div class="box-body-full">
                    <ul class="lbrcard contents">
                        <% if !@recomends.nil? and @recomends.count > 0
                               @recomends.each do |r| %>
                                <li class="tcard">
                                    <%= link_to r['title'], channel_article_path(@article.channel_id, r['id']) %>
                                </li>
                            <% end else %>
                            <li class="tcard">暂无</li>
                        <% end %>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>




<%= render 'layouts/footer' %>
<%= render 'layouts/baidu' %>
</body>
</html>
